-- =============================================================================
-- AegisLang Compliance Audit Log Table
-- Generated: {{ timestamp }}
-- Document: {{ doc_id }}
-- =============================================================================

-- Create audit log table for compliance tracking
CREATE TABLE IF NOT EXISTS compliance_audit_log (
    id BIGSERIAL PRIMARY KEY,

    -- Clause identification
    clause_id VARCHAR(255) NOT NULL,
    violation_type VARCHAR(100) NOT NULL,

    -- Context
    table_name VARCHAR(255),
    record_id VARCHAR(255),
    actor_id VARCHAR(255),

    -- Details
    violation_message TEXT,
    severity VARCHAR(50) DEFAULT 'medium',
    resolved BOOLEAN DEFAULT FALSE,
    resolved_at TIMESTAMP WITH TIME ZONE,
    resolved_by VARCHAR(255),
    resolution_notes TEXT,

    -- Metadata
    occurred_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

    -- Indexing hints
    CONSTRAINT chk_severity CHECK (severity IN ('low', 'medium', 'high', 'critical'))
);

-- Create indexes for common queries
CREATE INDEX IF NOT EXISTS idx_audit_clause_id ON compliance_audit_log(clause_id);
CREATE INDEX IF NOT EXISTS idx_audit_occurred_at ON compliance_audit_log(occurred_at);
CREATE INDEX IF NOT EXISTS idx_audit_violation_type ON compliance_audit_log(violation_type);
CREATE INDEX IF NOT EXISTS idx_audit_severity ON compliance_audit_log(severity);
CREATE INDEX IF NOT EXISTS idx_audit_resolved ON compliance_audit_log(resolved);
CREATE INDEX IF NOT EXISTS idx_audit_table_name ON compliance_audit_log(table_name);

-- Create view for unresolved violations
CREATE OR REPLACE VIEW unresolved_compliance_violations AS
SELECT
    id,
    clause_id,
    violation_type,
    table_name,
    record_id,
    violation_message,
    severity,
    occurred_at,
    EXTRACT(EPOCH FROM (NOW() - occurred_at)) / 3600 AS hours_open
FROM compliance_audit_log
WHERE resolved = FALSE
ORDER BY
    CASE severity
        WHEN 'critical' THEN 1
        WHEN 'high' THEN 2
        WHEN 'medium' THEN 3
        WHEN 'low' THEN 4
    END,
    occurred_at ASC;

-- Create summary view
CREATE OR REPLACE VIEW compliance_violation_summary AS
SELECT
    clause_id,
    violation_type,
    severity,
    COUNT(*) AS total_violations,
    SUM(CASE WHEN resolved THEN 1 ELSE 0 END) AS resolved_count,
    SUM(CASE WHEN NOT resolved THEN 1 ELSE 0 END) AS unresolved_count,
    MIN(occurred_at) AS first_occurrence,
    MAX(occurred_at) AS last_occurrence
FROM compliance_audit_log
GROUP BY clause_id, violation_type, severity
ORDER BY unresolved_count DESC, last_occurrence DESC;

-- Add table comment
COMMENT ON TABLE compliance_audit_log
IS 'AegisLang Compliance Audit Log - Tracks all compliance violations and their resolution status';
